<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estratégia Ypê - Mapa Colaborativo</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- Babel para JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out forwards; }
        
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }

        /* Loader */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- CONFIGURAÇÃO DO FIREBASE -->
    <script type="module">
        // Importa as funções necessárias do CDN do Google
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAqZK2CndUqHQ2meBxR7TrA5AiScWphS40",
            authDomain: "planejamento-ype.firebaseapp.com",
            projectId: "planejamento-ype",
            storageBucket: "planejamento-ype.firebasestorage.app",
            messagingSenderId: "759028249794",
            appId: "1:759028249794:web:386c91ceb5577c00f8b75b"
        };

        // Inicializa o Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Expõe o banco de dados e funções para o React (que roda no script babel abaixo)
        window.firebaseDB = db;
        window.firebaseDoc = doc;
        window.firebaseOnSnapshot = onSnapshot;
        window.firebaseSetDoc = setDoc;
        window.firebaseGetDoc = getDoc;

        // Dispara evento avisando que o Firebase está pronto
        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <!-- APLICAÇÃO REACT -->
    <script type="text/babel">
        const { useState, useRef, useEffect, useCallback } = React;

        // --- ÍCONES ---
        const Icon = ({ path, className, style }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} style={style}>
                {path}
            </svg>
        );

        const Icons = {
            Plus: (props) => <Icon {...props} path={<><path d="M5 12h14"/><path d="M12 5v14"/></>} />,
            Trash2: (props) => <Icon {...props} path={<><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></>} />,
            Layout: (props) => <Icon {...props} path={<><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/></>} />,
            Type: (props) => <Icon {...props} path={<><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" x2="15" y1="20" y2="20"/><line x1="12" x2="12" y1="4" y2="20"/></>} />,
            ZoomIn: (props) => <Icon {...props} path={<><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/><line x1="11" x2="11" y1="8" y2="14"/><line x1="8" x2="14" y1="11" y2="11"/></>} />,
            ZoomOut: (props) => <Icon {...props} path={<><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/><line x1="8" x2="14" y1="11" y2="11"/></>} />,
            Maximize: (props) => <Icon {...props} path={<><path d="M8 3H5a2 2 0 0 0-2 2v3"/><path d="M21 8V5a2 2 0 0 0-2-2h-3"/><path d="M3 16v3a2 2 0 0 0 2 2h3"/><path d="M16 21h3a2 2 0 0 0 2-2v-3"/></>} />,
            Target: (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></>} />,
            Layers: (props) => <Icon {...props} path={<><path d="m12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83Z"/><path d="m22 17.65-9.17 4.16a2 2 0 0 1-1.66 0L2 17.65"/><path d="m22 12.65-9.17 4.16a2 2 0 0 1-1.66 0L2 12.65"/></>} />,
            Play: (props) => <Icon {...props} path={<polygon points="5 3 19 12 5 21 5 3"/>} />,
            BarChart3: (props) => <Icon {...props} path={<><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></>} />,
            MousePointer2: (props) => <Icon {...props} path={<path d="m12 6 2-2-2-2-2 2 2 2zm0 12-2 2 2 2 2-2-2-2zm-6-6-2-2-2 2 2 2 2-2zm12 0 2-2 2 2-2 2 2-2z"/>} />, 
            AlignLeft: (props) => <Icon {...props} path={<><line x1="21" x2="3" y1="6" y2="6"/><line x1="15" x2="3" y1="12" y2="12"/><line x1="17" x2="3" y1="18" y2="18"/></>} />,
            Link: (props) => <Icon {...props} path={<><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></>} />,
            Save: (props) => <Icon {...props} path={<><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></>} />,
            RotateCcw: (props) => <Icon {...props} path={<><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></>} />,
            Cloud: (props) => <Icon {...props} path={<path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19h11zm-5.5 0V9m0 0l-3 3m3-3l3 3"/>} />,
            CloudCheck: (props) => <Icon {...props} path={<><path d="M12 10v6m0 0l-3-3m3 3l3-3"/><path d="M4 16.2a10 10 0 0 1 19.4 0"/></>} /> 
        };

        // --- TEMAS ---
        const THEMES = {
            blue: { main: '#2563eb', light: '#eff6ff', border: '#bfdbfe', label: 'Liderar' },
            pink: { main: '#db2777', light: '#fdf2f8', border: '#fbcfe8', label: 'Cuidar' },
            purple: { main: '#9333ea', light: '#faf5ff', border: '#e9d5ff', label: 'Inovar' },
            yellow: { main: '#ca8a04', light: '#fefce8', border: '#fef08a', label: 'Se Mostrar' },
            green: { main: '#16a34a', light: '#f0fdf4', border: '#bbf7d0', label: 'Crescer' },
            slate: { main: '#475569', light: '#f8fafc', border: '#e2e8f0', label: 'Produzir' },
            orange: { main: '#ea580c', light: '#fff7ed', border: '#fed7aa', label: 'Aprender' },
            teal: { main: '#0d9488', light: '#ccfbf1', border: '#5eead4', label: 'Comunicar' },
            indigo: { main: '#4f46e5', light: '#e0e7ff', border: '#818cf8', label: 'Desenvolver' },
            rose: { main: '#e11d48', light: '#ffe4e6', border: '#fda4af', label: 'Digitalizar' },
            cyan: { main: '#06b6d4', light: '#cffafe', border: '#67e8f9', label: 'Reconhecer' },
            stone: { main: '#78716c', light: '#f5f5f4', border: '#a8a29e', label: 'Implementar?' },
            lime: { main: '#65a30d', light: '#ecfccb', border: '#a3e635', label: 'Compartilhar?' },
            fuchsia: { main: '#c026d3', light: '#fae8ff', border: '#e879f9', label: 'Atrair?' },
        };

        // --- SEED DATA (Usado apenas se o banco estiver vazio) ---
        // (Aqui mantemos a estrutura completa que construímos)
        const INITIAL_NODES_DATA = [
            // LIDERAR
            { id: '1', type: 'dimension', label: 'LIDERAR', x: 0, y: 300, color: 'blue' },
            { id: '1-1', type: 'attribute', label: 'Pessoas', x: 300, y: 0, color: 'blue' },
            { id: '1-1-1', type: 'action', label: 'Atuação alinhada aos valores', description: 'Avaliação de performance com foco em comportamentos', x: 600, y: -100, color: 'blue' },
            { id: '1-1-1-k', type: 'kpi', label: 'Índice de Liderança', x: 900, y: -100, color: 'blue' },
            { id: '1-1-2', type: 'action', label: 'Desenvolvimento de pessoas', description: 'Avaliação do time, alcance de resultados, Feedbacks dados', x: 600, y: 0, color: 'blue' },
            { id: '1-1-2-k', type: 'kpi', label: 'Índice de Liderança', x: 900, y: 0, color: 'blue' },
            { id: '1-1-3', type: 'action', label: 'Pessoas certas nos lugares certos', description: 'Calibração de Performance, Rituais Ciclo de gente', x: 600, y: 100, color: 'blue' },
            { id: '1-1-4', type: 'action', label: 'Liderança Ypê', description: 'Academia de Liderança / Coaching em grupo', x: 600, y: 200, color: 'blue' },
            { id: '1-2', type: 'attribute', label: 'Mercado', x: 300, y: 550, color: 'blue' },
            { id: '1-2-1', type: 'action', label: 'Construção de marca', description: 'Construção de marca de sabonetes, distribuição de produto e execução PDV', x: 600, y: 350, color: 'blue' },
            { id: '1-2-1-k', type: 'kpi', label: 'Volume Sellout, Receita Líq, EBITDA', x: 900, y: 350, color: 'blue' },
            { id: '1-2-2', type: 'action', label: 'Revisão processo qualidade', description: 'Inauguração lab microbiologia, investir área fabril, reciclar e treinar', x: 600, y: 450, color: 'blue' },
            { id: '1-2-2-k', type: 'kpi', label: 'Indicadores de Qualidade', x: 900, y: 450, color: 'blue' },
            { id: '1-2-3', type: 'action', label: 'Investimento em novos CDs', description: '', x: 600, y: 550, color: 'blue' },
            { id: '1-2-4', type: 'action', label: 'Melhorar atendimento aos clientes', description: '', x: 600, y: 630, color: 'blue' },
            { id: '1-2-5', type: 'action', label: 'Melhorar categorias', description: 'Melhora da gestão de incentivos da equipe', x: 600, y: 710, color: 'blue' },
            { id: '1-2-5-k', type: 'kpi', label: 'Crescimento de vendas das categorias', x: 900, y: 710, color: 'blue' },
            { id: '1-2-6', type: 'action', label: 'Programa Excelência Comercial', description: '', x: 600, y: 810, color: 'blue' },

            // CUIDAR
            { id: '2', type: 'dimension', label: 'CUIDAR', x: 0, y: 1400, color: 'pink' },
            { id: '2-1', type: 'attribute', label: 'Clientes (consumidor patrão)', x: 300, y: 1100, color: 'pink' },
            { id: '2-1-1', type: 'action', label: 'Qualidade dos produtos', description: 'Qualidade de ponta a ponta e fazer certo da primeira vez.\nDiagnóstico de Maturidade da Qualidade.\nFluxo de Revisão de Projetos (VMO).\nProjeto de IA SAC/CRM.\nSEY', x: 600, y: 1000, color: 'pink' },
            { id: '2-1-1-k', type: 'kpi', label: 'SAC, CRM, IQF, PTP, BPF, ATD, Custo de não qualidade', x: 900, y: 1000, color: 'pink' },
            { id: '2-1-2', type: 'action', label: 'Proximidade com o cliente', description: 'Programa/Iniciativa Rota', x: 600, y: 1150, color: 'pink' },
            { id: '2-1-3', type: 'action', label: 'Satisfação do cliente', description: 'Olhando preço, qualidade e inovação', x: 600, y: 1250, color: 'pink' },
            { id: '2-2', type: 'attribute', label: 'Colaboradores', x: 300, y: 1700, color: 'pink' },
            { id: '2-2-1', type: 'action', label: 'Segurança', description: 'Programa Cuidar (Social, Psicólogo, Médico da Família, Financeiro).\nCenso Saúde Mental.', x: 600, y: 1400, color: 'pink' },
            { id: '2-2-2', type: 'action', label: 'Engajamento dos colaboradores', description: 'Pesquisas de engajamento (Pulse, GPTW).\nOlimpíadas Ypê.\nNatal.\nDia da Familia.\nCesta de produtos para família.', x: 600, y: 1550, color: 'pink' },
            { id: '2-2-3', type: 'action', label: 'Reconhecimento', description: '(Programa Cultivar) Atitude, Gratidão, Projetos Destaque e Ydealize.\nMérito de acordo com avaliação de performance.\nPromoção e Comitê de Carreira para coordenadores.', x: 600, y: 1750, color: 'pink' },
            { id: '2-2-4', type: 'action', label: 'Diversidade e Inclusão', description: 'Foco em Mulheres na Liderança.\nAtração PCD.', x: 600, y: 1950, color: 'pink' },
            { id: '2-2-5', type: 'action', label: 'Jornada do colaborador', description: 'Ciclo de Gente.\nRevitaliza RH (Folha, Ciclo, Educação).\nOnboarding KIT IT.\nOnboarding Kit Boas vindas.', x: 600, y: 2100, color: 'pink' },
            { id: '2-3', type: 'attribute', label: 'Equipamentos', x: 300, y: 2300, color: 'pink' },
            { id: '2-3-1', type: 'action', label: 'TPM', description: 'Programa de Conservação Autônoma TPM', x: 600, y: 2300, color: 'pink' },

            // INOVAR
            { id: '3', type: 'dimension', label: 'INOVAR', x: 0, y: 2800, color: 'purple' },
            { id: '3-1', type: 'attribute', label: 'Melhoria contínua', x: 300, y: 2700, color: 'purple' },
            { id: '3-1-1', type: 'action', label: 'PDCA (Cultivar)', description: 'Dar ideias de melhoria pelo Projeto Ydealize (parte do projeto Cultivar)', x: 600, y: 2500, color: 'purple' },
            { id: '3-1-2', type: 'action', label: 'PDCA (RH)', description: 'Revitaliza RH - nova plataforma digital para Folha, Ciclo, Educação', x: 600, y: 2600, color: 'purple' },
            { id: '3-1-3', type: 'action', label: 'Imersão nas Áreas', description: '+ Design Thinking', x: 600, y: 2700, color: 'purple' },
            { id: '3-1-4', type: 'action', label: 'Anomalias', description: 'Projeto e Registro de Anomalias', x: 600, y: 2800, color: 'purple' },
            { id: '3-1-5', type: 'action', label: 'Grupos de Melhoria', description: 'Grupos de Melhoria de Resultado', x: 600, y: 2900, color: 'purple' },
            { id: '3-1-6', type: 'action', label: 'GIGA', description: 'Gestão autônoma', x: 600, y: 3000, color: 'purple' },
            { id: '3-2', type: 'attribute', label: 'Experimentar o novo', x: 300, y: 3300, color: 'purple' },
            { id: '3-2-1', type: 'action', label: 'Dia Y', description: '', x: 600, y: 3150, color: 'purple' },
            { id: '3-2-2', type: 'action', label: 'Ydealize', description: '', x: 600, y: 3230, color: 'purple' },
            { id: '3-2-3', type: 'action', label: 'UnYpê', description: 'Aprender competências para o futuro', x: 600, y: 3310, color: 'purple' },
            { id: '3-2-4', type: 'action', label: 'Comitê IA', description: 'Comitê de Inteligência Artificial', x: 600, y: 3390, color: 'purple' },
            { id: '3-2-5', type: 'action', label: 'Yara', description: 'IA da Ypê', x: 600, y: 3470, color: 'purple' },

            // SE MOSTRAR
            { id: '4', type: 'dimension', label: 'SE MOSTRAR', x: 0, y: 3800, color: 'yellow' },
            { id: '4-1', type: 'attribute', label: 'Ética', x: 300, y: 3750, color: 'yellow' },
            { id: '4-1-1', type: 'action', label: 'Be Compliance', description: 'Canal de Ética Ypê.\nComitê de integridade.\nCódigo de Conduta.\nAgentes de Conformidade.', x: 600, y: 3700, color: 'yellow' },
            { id: '4-1-2', type: 'action', label: 'Compliance e Anti Corrupção', description: 'Selo Pró Etica concedido pela CGU.', x: 600, y: 3800, color: 'yellow' },
            { id: '4-2', type: 'attribute', label: 'Reputação', x: 300, y: 4000, color: 'yellow' },
            { id: '4-2-1', type: 'action', label: 'Ser e parecer – equalizar valor', description: 'Garantir percepção alinhada à qualidade.\nEvoluir pricing e posicionamento.\nAtributos e embalagens como alavancas.\nExcelência na qualidade.\nWar game lava roupas.\nProjeto Embaixadores.\nMovimento Transparência 100%.', x: 600, y: 3950, color: 'yellow' },
            { id: '4-2-1-k', type: 'kpi', label: '% MC, % MCC, Sell-Out, Share Volume (LRP, LRL, Amaciantes), Brand Power, ROL', x: 900, y: 3950, color: 'yellow' },
            { id: '4-2-2', type: 'action', label: 'Nacionalidade', description: 'Projeto de posicionamento para Marca Corporativa', x: 600, y: 4100, color: 'yellow' },
            { id: '4-3', type: 'attribute', label: 'Sustentabilidade', x: 300, y: 4400, color: 'yellow' },
            { id: '4-3-1', type: 'action', label: 'Sustentabilidade no centro', description: 'Plano diretor de sustentabilidade', x: 600, y: 4200, color: 'yellow' },
            { id: '4-3-2', type: 'action', label: 'Relatório de Sustentabilidade', description: 'Publicação voluntária', x: 600, y: 4280, color: 'yellow' },
            { id: '4-3-3', type: 'action', label: 'UN Pacto global', description: '', x: 600, y: 4360, color: 'yellow' },
            { id: '4-3-4', type: 'action', label: 'Movimento + água', description: '(diversas iniciativas)', x: 600, y: 4440, color: 'yellow' },
            { id: '4-3-5', type: 'action', label: 'Movimento Mente em Foco', description: 'Programa Cuidar (Social, Psicólogo, Médico, Financeiro)', x: 600, y: 4520, color: 'yellow' },
            { id: '4-3-6', type: 'action', label: 'Movimento Educa2030', description: 'Educary, EducaYpê, Unico Skill', x: 600, y: 4600, color: 'yellow' },
            { id: '4-4', type: 'attribute', label: 'Marca Empregadora & Qualidade', x: 300, y: 4800, color: 'yellow' },
            { id: '4-4-1', type: 'action', label: 'Employer branding', description: 'Premiação GPTW', x: 600, y: 4750, color: 'yellow' },
            { id: '4-4-2', type: 'action', label: 'Qualidade', description: 'Nossa melhor propaganda é a qualidade', x: 600, y: 4850, color: 'yellow' },
            { id: '4-5', type: 'attribute', label: 'Inclusão e Diversidade', x: 300, y: 5100, color: 'yellow' },
            { id: '4-5-1', type: 'action', label: 'Inclusão', description: 'Rede Empresarial de Inclusão Social (REIS) / Pacto pela Inclusão', x: 600, y: 5000, color: 'yellow' },
            { id: '4-5-2', type: 'action', label: 'Mulheres', description: 'Selo Pró-Ética Mulheres / Encontros Mulheres Essenciais / Woman on Board', x: 600, y: 5100, color: 'yellow' },
            { id: '4-5-3', type: 'action', label: 'PCD', description: 'Programa Aprendizes / Projeto Promotor com Deficiência', x: 600, y: 5200, color: 'yellow' },

            // CRESCER
            { id: '5', type: 'dimension', label: 'CRESCER', x: 0, y: 5600, color: 'green' },
            { id: '5-1', type: 'attribute', label: 'Expansão', x: 300, y: 5500, color: 'green' },
            { id: '5-1-1', type: 'action', label: 'Uma Ypê em cada região', description: 'Atuar regionalmente como unidades de negócio.\nPortfólio e comunicação regionalizados (Claims).\nRevisar malha produtiva e logística.\nPotencializar vendas e merchandising.\nEvoluir atendimento financeiro.\nGerir regional com DRE (ponta a ponta).\nGarantir analytics regionalizado.', x: 600, y: 5350, color: 'green' },
            { id: '5-1-1-k', type: 'kpi', label: 'Margem de servir, OTIF, Distribuição inovação, Yperexecução, ROL Share regional', x: 900, y: 5350, color: 'green' },
            { id: '5-1-2', type: 'action', label: 'Reconhecimento Marca', description: 'Única marca limpeza no ranking marcas valiosas Brasil 2025', x: 600, y: 5550, color: 'green' },
            { id: '5-2', type: 'attribute', label: 'A Ypê está onde o consumidor está', x: 300, y: 5850, color: 'green' },
            { id: '5-2-1', type: 'action', label: 'Ampliar relevância', description: 'Disponibilidade física (omnicanalidade): novos canais (Food, Lavanderia, Perfumaria, Digitais).\nEcossistema serviços.\nDisponibilidade mental: comunicação e redes sociais.\nDiferencial qualidade e benefício.\nConstruir marcas cuidados pessoais.', x: 600, y: 5750, color: 'green' },
            { id: '5-2-1-k', type: 'kpi', label: 'Brand Power, % ROL novos canais, ROI mídia', x: 900, y: 5750, color: 'green' },
            { id: '5-3', type: 'attribute', label: 'Foco no consumidor muda o jogo', x: 300, y: 6150, color: 'green' },
            { id: '5-3-1', type: 'action', label: 'Metas Share e Portfólio', description: 'Roupas: 15|15|30|30 (% share vol).\nCasa: 3º share vol, 2º share valor, 10% mercado.\nPia: 41% share vol.\nBanho: 2ª marca sabonete, Top 2 banho.\nExecução lançamentos.\nInovação e qualidade (embalagens, claims).', x: 600, y: 6050, color: 'green' },
            { id: '5-3-1-k', type: 'kpi', label: 'Brand Power, Sell out vol, Share Valor/Vol, % ROL Inovação, Distribuição inovação', x: 900, y: 6050, color: 'green' },
            { id: '5-4', type: 'attribute', label: 'Gestão, Parcerias & Estratégia', x: 300, y: 6450, color: 'green' },
            { id: '5-4-1', type: 'action', label: 'Gestão de Crise', description: 'Relacionamento com cliente final e órgãos reguladores em situações de crise', x: 600, y: 6350, color: 'green' },
            { id: '5-4-2', type: 'action', label: 'Parcerias', description: 'Parcerias com outras marcas (ex: Loccitane). Posicionamento de marca.', x: 600, y: 6450, color: 'green' },
            { id: '5-4-3', type: 'action', label: 'Cascatear Estratégia', description: 'Informar e engajar.\nConvenção líderes, reuniões cascateamento, trimestral resultados, rituais SEY, comunicação interna, PPR.', x: 600, y: 6550, color: 'green' },

            // PRODUZIR
            { id: '6', type: 'dimension', label: 'PRODUZIR', x: 0, y: 6900, color: 'slate' },
            { id: '6-1', type: 'attribute', label: 'Produtividade', x: 300, y: 6800, color: 'slate' },
            { id: '6-1-1', type: 'action', label: 'Redução de custos (Comercial)', description: 'Máquina Comercial e de execução.\nEvoluir gestão de vendas, trade e logística.\nRever, simplificar, desburocratizar e automatizar processos.\nAdotar tecnologia como alavanca.\nAvaliar requisitos e ajustes para nova realidade.\nDesenvolver profissional de vendas e merchandising.', x: 600, y: 6700, color: 'slate' },
            { id: '6-1-1-k', type: 'kpi', label: 'Volume Sell Out, Yperexecução, OTIF, Advantage, Margem de Servir, Produtividade Vendas/Promotores', x: 900, y: 6700, color: 'slate' },
            { id: '6-1-2', type: 'action', label: 'Aumento de lucratividade (Industrial)', description: 'Produção e logística motor.\nCadeia responsiva e flexível.\nParque industrial/CD flexível e próximo.\nInfra/capacidade alinhadas.\nFlexibilidade (make/borrow/buy).\nIBP eficaz (sincronizar áreas).\nQualidade de ponta a ponta.\nGanhar produtividade.', x: 600, y: 6900, color: 'slate' },
            { id: '6-1-2-k', type: 'kpi', label: 'Frete (distrib/transf), OTIF, Ruptura, Custo variável/ROL, Custos CDs, Advantage, IBP, OEE, GGF, Acuracidade SKU/CD', x: 900, y: 6900, color: 'slate' },
            { id: '6-2', type: 'attribute', label: 'Automatização', x: 300, y: 7200, color: 'slate' },
            { id: '6-2-1', type: 'action', label: 'Automatização de backoffice', description: 'Revisar processos e aplicar tecnologia (produtividade).\nDados como força motriz.\nRever, simplificar, desburocratizar.\nAdotar tecnologia.\nAvaliar requisitos e ajustes para nova realidade.\nReforçar mentalidade total experience.', x: 600, y: 7200, color: 'slate' },
            { id: '6-2-1-k', type: 'kpi', label: '% R$ Pacote Gente Backoffice/ ROL', x: 900, y: 7200, color: 'slate' },
            { id: '6-3', type: 'attribute', label: 'Produto (manufatura)', x: 300, y: 7400, color: 'slate' },
            
            // APRENDER
            { id: '7', type: 'dimension', label: 'APRENDER', x: 0, y: 7800, color: 'orange' },
            { id: '7-1', type: 'attribute', label: 'Negócio & Ecossistema', x: 300, y: 7700, color: 'orange' },
            { id: '7-1-1', type: 'action', label: 'Ecossistema de Aprendizagem', description: 'Hubs (Liderança, Estratégico, Backoffice, Comercial e Operações).\nDia Y.', x: 600, y: 7600, color: 'orange' },
            { id: '7-1-2', type: 'action', label: 'Academias', description: 'Academia de Key Users.\nAcademia dos líderes.', x: 600, y: 7700, color: 'orange' },
            { id: '7-1-3', type: 'action', label: 'TPM Educacional', description: 'Simulador de aprendizagem.\nDesenho LUP.\nMatriz de Habilidade.', x: 600, y: 7800, color: 'orange' },
            { id: '7-1-4', type: 'action', label: 'Programas Específicos', description: 'Único Skill.\nImersão em Vendas.', x: 600, y: 7900, color: 'orange' },
            { id: '7-2', type: 'attribute', label: 'Técnica & Futuro', x: 300, y: 8100, color: 'orange' },
            { id: '7-2-1', type: 'action', label: 'Aprendizagem Técnica', description: 'CID - Política, procedimentos (IOP)', x: 600, y: 8050, color: 'orange' },
            { id: '7-2-2', type: 'action', label: 'Upskilling e Reskilling', description: 'Ypê Talks', x: 600, y: 8150, color: 'orange' },
            { id: '7-3', type: 'attribute', label: 'Experiência do Colaborador', x: 300, y: 8300, color: 'orange' },
            { id: '7-3-1', type: 'action', label: 'Jornada & Talentos', description: 'Onboarding.\nTalentos (Coordenadores).', x: 600, y: 8300, color: 'orange' },

            // COMUNICAR
            { id: '8', type: 'dimension', label: 'COMUNICAR', x: 0, y: 8600, color: 'teal' },
            { id: '8-1', type: 'attribute', label: 'Colaboradores', x: 300, y: 8550, color: 'teal' },
            { id: '8-1-1', type: 'action', label: 'Canais Internos & Liderança', description: 'Canais, tom de voz, narrativa, deck de mensagens, preparação da liderança', x: 600, y: 8550, color: 'teal' },
            { id: '8-2', type: 'attribute', label: 'Mercado', x: 300, y: 8750, color: 'teal' },
            { id: '8-2-1', type: 'action', label: 'Programa de Embaixadores', description: 'Embaixadores da marca', x: 600, y: 8700, color: 'teal' },
            { id: '8-2-2', type: 'action', label: 'Marca Empregadora', description: 'Programa de Marca Empregadora', x: 600, y: 8800, color: 'teal' },
            { id: '8-2-2-k', type: 'kpi', label: '% Retenção talentos', x: 900, y: 8800, color: 'teal' },

            // DESENVOLVER
            { id: '9', type: 'dimension', label: 'DESENVOLVER', x: 0, y: 9200, color: 'indigo' },
            { id: '9-1', type: 'attribute', label: 'UnYpê & Educação', x: 300, y: 9100, color: 'indigo' },
            { id: '9-1-1', type: 'action', label: 'Plataforma Única', description: 'Programa Plataforma único', x: 600, y: 9050, color: 'indigo' },
            { id: '9-1-2', type: 'action', label: 'Educar Y', description: 'Educar Y', x: 600, y: 9150, color: 'indigo' },
            { id: '9-2', type: 'attribute', label: 'Ciclo de Gente', x: 300, y: 9300, color: 'indigo' },
            { id: '9-2-1', type: 'action', label: 'Performance & Metas', description: 'Performance, feedback, metas individuais', x: 600, y: 9300, color: 'indigo' },
            { id: '9-3', type: 'attribute', label: 'Técnico', x: 300, y: 9450, color: 'indigo' },
            { id: '9-3-1', type: 'action', label: 'PROTEC', description: 'Programa de Desenvolvimento Técnico e Certificação Ypê', x: 600, y: 9450, color: 'indigo' },
            { id: '9-4', type: 'attribute', label: 'Reconhecimento', x: 300, y: 9650, color: 'indigo' },
            { id: '9-4-1', type: 'action', label: 'Programa Cultivar', description: 'Atitude, Gratidão, Projetos Destaque e Ydealize', x: 600, y: 9600, color: 'indigo' },
            { id: '9-4-2', type: 'action', label: 'Mérito', description: 'Mérito de acordo com avaliação de performance', x: 600, y: 9700, color: 'indigo' },

            // DIGITALIZAR
            { id: '10', type: 'dimension', label: 'DIGITALIZAR', x: 0, y: 9900, color: 'rose' },
            { id: '10-1', type: 'attribute', label: 'Inovação & Dados', x: 300, y: 9850, color: 'rose' },
            { id: '10-1-1', type: 'action', label: 'Hackathon', description: 'Dia Y - Hackathon', x: 600, y: 9800, color: 'rose' },
            { id: '10-1-2', type: 'action', label: 'Capacitação de Dados', description: 'Capacitação em Dados', x: 600, y: 9900, color: 'rose' },
            { id: '10-1-3', type: 'action', label: 'Ypê Talks', description: 'Ypê Talks', x: 600, y: 10000, color: 'rose' },

            // RECONHECER
            { id: '11', type: 'dimension', label: 'RECONHECER', x: 0, y: 10300, color: 'cyan' },
            { id: '11-1', type: 'attribute', label: 'Programas Internos', x: 300, y: 10300, color: 'cyan' },
            { id: '11-1-1', type: 'action', label: 'Programa Cultivar', description: 'Reconhecimento', x: 600, y: 10250, color: 'cyan' },
            { id: '11-1-2', type: 'action', label: 'The Voice Ypê', description: 'Talentos internos', x: 600, y: 10350, color: 'cyan' },
            
            // IMPLEMENTAR
            { id: '12', type: 'dimension', label: 'IMPLEMENTAR', x: 0, y: 10800, color: 'stone' },
            { id: '12-1', type: 'attribute', label: 'Governança', x: 300, y: 10800, color: 'stone' },
            { id: '12-1-1', type: 'action', label: 'Padrão', description: 'Não há padrão ou governança', x: 600, y: 10800, color: 'stone' },

            // COMPARTILHAR
            { id: '13', type: 'dimension', label: 'COMPARTILHAR', x: 0, y: 11400, color: 'lime' },
            { id: '13-1', type: 'attribute', label: 'Estratégia', x: 300, y: 11200, color: 'lime' },
            { id: '13-1-1', type: 'action', label: 'Informar e engajar', description: 'Convenção líderes\nReuniões de cascateamento\nReunião trimestral\nRituais de SEY\nComunicação interna\nPPR', x: 600, y: 11200, color: 'lime' },
            { id: '13-2', type: 'attribute', label: 'Comunicação', x: 300, y: 11500, color: 'lime' },
            { id: '13-2-1', type: 'action', label: 'Interna', description: 'Canais', x: 600, y: 11450, color: 'lime' },
            { id: '13-2-2', type: 'action', label: 'Entre times', description: '?', x: 600, y: 11550, color: 'lime' },
            { id: '13-3', type: 'attribute', label: 'Gestão Conhecimento', x: 300, y: 11700, color: 'lime' },
            { id: '13-3-1', type: 'action', label: 'Gestão', description: '?', x: 600, y: 11700, color: 'lime' },

            // ATRAIR
            { id: '14', type: 'dimension', label: 'ATRAIR', x: 0, y: 12000, color: 'fuchsia' },
            { id: '14-1', type: 'attribute', label: 'Atração', x: 300, y: 12000, color: 'fuchsia' },
            { id: '14-1-1', type: 'action', label: 'Estágio', description: 'Programa de Estágio', x: 600, y: 12000, color: 'fuchsia' },
        ];

        const INITIAL_EDGES_DATA = [
            // (Conexões das outras dimensões mantidas...)
            { id: 'e1-11', source: '1', target: '1-1' }, { id: 'e11-1', source: '1-1', target: '1-1-1' }, { id: 'e111-k', source: '1-1-1', target: '1-1-1-k' }, { id: 'e11-2', source: '1-1', target: '1-1-2' }, { id: 'e112-k', source: '1-1-2', target: '1-1-2-k' }, { id: 'e11-3', source: '1-1', target: '1-1-3' }, { id: 'e11-4', source: '1-1', target: '1-1-4' }, { id: 'e1-12', source: '1', target: '1-2' }, { id: 'e12-1', source: '1-2', target: '1-2-1' }, { id: 'e121-k', source: '1-2-1', target: '1-2-1-k' }, { id: 'e12-2', source: '1-2', target: '1-2-2' }, { id: 'e122-k', source: '1-2-2', target: '1-2-2-k' }, { id: 'e12-3', source: '1-2', target: '1-2-3' }, { id: 'e12-4', source: '1-2', target: '1-2-4' }, { id: 'e12-5', source: '1-2', target: '1-2-5' }, { id: 'e125-k', source: '1-2-5', target: '1-2-5-k' }, { id: 'e12-6', source: '1-2', target: '1-2-6' },
            { id: 'e2-21', source: '2', target: '2-1' }, { id: 'e21-1', source: '2-1', target: '2-1-1' }, { id: 'e211-k', source: '2-1-1', target: '2-1-1-k' }, { id: 'e21-2', source: '2-1', target: '2-1-2' }, { id: 'e21-3', source: '2-1', target: '2-1-3' }, { id: 'e2-22', source: '2', target: '2-2' }, { id: 'e22-1', source: '2-2', target: '2-2-1' }, { id: 'e22-2', source: '2-2', target: '2-2-2' }, { id: 'e22-3', source: '2-2', target: '2-2-3' }, { id: 'e22-4', source: '2-2', target: '2-2-4' }, { id: 'e22-5', source: '2-2', target: '2-2-5' }, { id: 'e2-23', source: '2', target: '2-3' }, { id: 'e23-1', source: '2-3', target: '2-3-1' },
            { id: 'e3-31', source: '3', target: '3-1' }, { id: 'e31-1', source: '3-1', target: '3-1-1' }, { id: 'e31-2', source: '3-1', target: '3-1-2' }, { id: 'e31-3', source: '3-1', target: '3-1-3' }, { id: 'e31-4', source: '3-1', target: '3-1-4' }, { id: 'e31-5', source: '3-1', target: '3-1-5' }, { id: 'e31-6', source: '3-1', target: '3-1-6' }, { id: 'e3-32', source: '3', target: '3-2' }, { id: 'e32-1', source: '3-2', target: '3-2-1' }, { id: 'e32-2', source: '3-2', target: '3-2-2' }, { id: 'e32-3', source: '3-2', target: '3-2-3' }, { id: 'e32-4', source: '3-2', target: '3-2-4' }, { id: 'e32-5', source: '3-2', target: '3-2-5' },
            { id: 'e4-41', source: '4', target: '4-1' }, { id: 'e41-1', source: '4-1', target: '4-1-1' }, { id: 'e41-2', source: '4-1', target: '4-1-2' }, { id: 'e4-42', source: '4', target: '4-2' }, { id: 'e42-1', source: '4-2', target: '4-2-1' }, { id: 'e421-k', source: '4-2-1', target: '4-2-1-k' }, { id: 'e42-2', source: '4-2', target: '4-2-2' }, { id: 'e4-43', source: '4', target: '4-3' }, { id: 'e43-1', source: '4-3', target: '4-3-1' }, { id: 'e43-2', source: '4-3', target: '4-3-2' }, { id: 'e43-3', source: '4-3', target: '4-3-3' }, { id: 'e43-4', source: '4-3', target: '4-3-4' }, { id: 'e43-5', source: '4-3', target: '4-3-5' }, { id: 'e43-6', source: '4-3', target: '4-3-6' }, { id: 'e4-44', source: '4', target: '4-4' }, { id: 'e44-1', source: '4-4', target: '4-4-1' }, { id: 'e44-2', source: '4-4', target: '4-4-2' }, { id: 'e4-45', source: '4', target: '4-5' }, { id: 'e45-1', source: '4-5', target: '4-5-1' }, { id: 'e45-2', source: '4-5', target: '4-5-2' }, { id: 'e45-3', source: '4-5', target: '4-5-3' },
            { id: 'e5-51', source: '5', target: '5-1' }, { id: 'e51-1', source: '5-1', target: '5-1-1' }, { id: 'e511-k', source: '5-1-1', target: '5-1-1-k' }, { id: 'e51-2', source: '5-1', target: '5-1-2' }, { id: 'e5-52', source: '5', target: '5-2' }, { id: 'e52-1', source: '5-2', target: '5-2-1' }, { id: 'e521-k', source: '5-2-1', target: '5-2-1-k' }, { id: 'e5-53', source: '5', target: '5-3' }, { id: 'e53-1', source: '5-3', target: '5-3-1' }, { id: 'e531-k', source: '5-3-1', target: '5-3-1-k' }, { id: 'e5-54', source: '5', target: '5-4' }, { id: 'e54-1', source: '5-4', target: '5-4-1' }, { id: 'e54-2', source: '5-4', target: '5-4-2' }, { id: 'e54-3', source: '5-4', target: '5-4-3' },
            { id: 'e6-61', source: '6', target: '6-1' }, { id: 'e61-1', source: '6-1', target: '6-1-1' }, { id: 'e611-k', source: '6-1-1', target: '6-1-1-k' }, { id: 'e61-2', source: '6-1', target: '6-1-2' }, { id: 'e612-k', source: '6-1-2', target: '6-1-2-k' }, { id: 'e6-62', source: '6', target: '6-2' }, { id: 'e62-1', source: '6-2', target: '6-2-1' }, { id: 'e621-k', source: '6-2-1', target: '6-2-1-k' }, { id: 'e6-63', source: '6', target: '6-3' },
            { id: 'e7-71', source: '7', target: '7-1' }, { id: 'e71-1', source: '7-1', target: '7-1-1' }, { id: 'e71-2', source: '7-1', target: '7-1-2' }, { id: 'e71-3', source: '7-1', target: '7-1-3' }, { id: 'e71-4', source: '7-1', target: '7-1-4' }, { id: 'e7-72', source: '7', target: '7-2' }, { id: 'e72-1', source: '7-2', target: '7-2-1' }, { id: 'e72-2', source: '7-2', target: '7-2-2' }, { id: 'e7-73', source: '7', target: '7-3' }, { id: 'e73-1', source: '7-3', target: '7-3-1' },
            { id: 'e8-81', source: '8', target: '8-1' }, { id: 'e81-1', source: '8-1', target: '8-1-1' }, { id: 'e8-82', source: '8', target: '8-2' }, { id: 'e82-1', source: '8-2', target: '8-2-1' }, { id: 'e82-2', source: '8-2', target: '8-2-2' }, { id: 'e822-k', source: '8-2-2', target: '8-2-2-k' },
            { id: 'e9-91', source: '9', target: '9-1' }, { id: 'e91-1', source: '9-1', target: '9-1-1' }, { id: 'e91-2', source: '9-1', target: '9-1-2' }, { id: 'e9-92', source: '9', target: '9-2' }, { id: 'e92-1', source: '9-2', target: '9-2-1' }, { id: 'e9-93', source: '9', target: '9-3' }, { id: 'e93-1', source: '9-3', target: '9-3-1' }, { id: 'e9-94', source: '9', target: '9-4' }, { id: 'e94-1', source: '9-4', target: '9-4-1' }, { id: 'e94-2', source: '9-4', target: '9-4-2' },
            { id: 'e10-101', source: '10', target: '10-1' }, { id: 'e101-1', source: '10-1', target: '10-1-1' }, { id: 'e101-2', source: '10-1', target: '10-1-2' }, { id: 'e101-3', source: '10-1', target: '10-1-3' },
            { id: 'e11-111', source: '11', target: '11-1' }, { id: 'e111-1', source: '11-1', target: '11-1-1' }, { id: 'e111-2', source: '11-1', target: '11-1-2' },
            { id: 'e12-121', source: '12', target: '12-1' }, { id: 'e121-1', source: '12-1', target: '12-1-1' },
            { id: 'e13-131', source: '13', target: '13-1' }, { id: 'e131-1', source: '13-1', target: '13-1-1' }, { id: 'e13-132', source: '13', target: '13-2' }, { id: 'e132-1', source: '13-2', target: '13-2-1' }, { id: 'e132-2', source: '13-2', target: '13-2-2' }, { id: 'e13-133', source: '13', target: '13-3' }, { id: 'e133-1', source: '13-3', target: '13-3-1' },
            { id: 'e14-141', source: '14', target: '14-1' }, { id: 'e141-1', source: '14-1', target: '14-1-1' },
        ];

        function App() {
            // Estado local inicializado com dados vazios para evitar erro antes do sync
            const [nodes, setNodes] = useState([]);
            const [edges, setEdges] = useState([]);
            const [selectedNodeId, setSelectedNodeId] = useState(null);
            const [isSyncing, setIsSyncing] = useState(true);
            
            // Viewport
            const [scale, setScale] = useState(0.5); 
            const [pan, setPan] = useState({ x: 50, y: 50 });
            
            // Interação
            const [isDraggingNode, setIsDraggingNode] = useState(null);
            const [isPanning, setIsPanning] = useState(false);
            const [lastMousePos, setLastMousePos] = useState({ x: 0, y: 0 });

            const containerRef = useRef(null);

            // --- FIREBASE SYNC ---
            useEffect(() => {
                const initSync = async () => {
                    if (!window.firebaseDB) {
                        // Aguarda evento de carregamento se o script ainda não rodou
                        window.addEventListener('firebase-ready', initSync);
                        return;
                    }

                    const db = window.firebaseDB;
                    const docRef = window.firebaseDoc(db, "maps", "ype_v1");

                    // Listener em tempo real
                    const unsubscribe = window.firebaseOnSnapshot(docRef, async (docSnap) => {
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            // Se não estamos arrastando (para evitar conflito de UI), atualiza
                            if (!isDraggingNode) {
                                setNodes(data.nodes || []);
                                setEdges(data.edges || []);
                            }
                        } else {
                            // Se documento não existe, cria com o SEED
                            await window.firebaseSetDoc(docRef, {
                                nodes: INITIAL_NODES_DATA,
                                edges: INITIAL_EDGES_DATA
                            });
                        }
                        setIsSyncing(false);
                    });

                    return unsubscribe;
                };

                initSync();
            }, []);

            // Função para salvar no Firebase
            const saveToCloud = useCallback(async (newNodes, newEdges) => {
                if (!window.firebaseDB) return;
                const db = window.firebaseDB;
                const docRef = window.firebaseDoc(db, "maps", "ype_v1");
                
                try {
                    await window.firebaseSetDoc(docRef, {
                        nodes: newNodes,
                        edges: newEdges
                    }, { merge: true });
                } catch (e) {
                    console.error("Erro ao salvar:", e);
                }
            }, []);


            // --- Handlers de Mouse ---
            const handleMouseDown = (e) => {
                if (e.target.closest('button') || e.target.closest('input') || e.target.closest('textarea') || e.target.closest('select')) return;

                const nodeElement = e.target.closest('[data-nodeid]');

                if (nodeElement) {
                    const nodeId = nodeElement.dataset.nodeid;
                    setIsDraggingNode(nodeId);
                    setLastMousePos({ x: e.clientX, y: e.clientY });
                    setSelectedNodeId(nodeId);
                    e.stopPropagation();
                } else {
                    setIsPanning(true);
                    setLastMousePos({ x: e.clientX, y: e.clientY });
                    setSelectedNodeId(null);
                }
            };

            const handleMouseMove = useCallback((e) => {
                const deltaX = e.clientX - lastMousePos.x;
                const deltaY = e.clientY - lastMousePos.y;

                if (isDraggingNode) {
                    const newNodes = nodes.map(node => {
                        if (node.id === isDraggingNode) {
                            return {
                                ...node,
                                x: node.x + deltaX / scale,
                                y: node.y + deltaY / scale
                            };
                        }
                        return node;
                    });
                    setNodes(newNodes);
                    setLastMousePos({ x: e.clientX, y: e.clientY });
                } else if (isPanning) {
                    setPan((prev) => ({
                        x: prev.x + deltaX,
                        y: prev.y + deltaY
                    }));
                    setLastMousePos({ x: e.clientX, y: e.clientY });
                }
            }, [isDraggingNode, isPanning, lastMousePos, scale, nodes]);

            const handleMouseUp = () => {
                if (isDraggingNode) {
                    saveToCloud(nodes, edges); // Salva ao soltar
                }
                setIsDraggingNode(null);
                setIsPanning(false);
            };

            // --- CRUD ---
            
            const handleUpdateNode = (id, field, value) => {
                const newNodes = nodes.map(n => n.id === id ? { ...n, [field]: value } : n);
                setNodes(newNodes);
                saveToCloud(newNodes, edges);
            };

            const getParentId = (childId) => {
                const edge = edges.find(e => e.target === childId);
                return edge ? edge.source : '';
            };

            const handleRelinkNode = (childId, newParentId) => {
                if (!newParentId) return;

                const newParentNode = nodes.find(n => n.id === newParentId);
                const childNode = nodes.find(n => n.id === childId);

                const newEdges = edges.filter(e => e.target !== childId);
                newEdges.push({ id: `e${newParentId}-${childId}-${Date.now()}`, source: newParentId, target: childId });
                
                let newNodes = nodes;
                if (newParentNode && childNode) {
                    newNodes = nodes.map(n => n.id === childId ? {
                        ...n,
                        x: newParentNode.x + 250,
                        y: newParentNode.y + 20,
                        color: newParentNode.color
                    } : n);
                }
                
                setNodes(newNodes);
                setEdges(newEdges);
                saveToCloud(newNodes, newEdges);
            };

            const handleAddNode = (type) => {
                const parentId = selectedNodeId;
                const parentNode = nodes.find(n => n.id === parentId);
                
                const newNodeId = Date.now().toString();
                
                let startX = parentNode ? parentNode.x + 280 : (-pan.x + 100 + Math.random() * 50) / scale;
                let startY = parentNode ? parentNode.y : (-pan.y + 100 + Math.random() * 50) / scale;

                if (type === 'dimension' && !parentNode) {
                   const maxY = nodes.reduce((max, n) => Math.max(max, n.y), 0);
                   startY = maxY + 400;
                   startX = 0;
                }

                const newNode = {
                    id: newNodeId,
                    type: type,
                    label: type === 'dimension' ? 'Nova Dimensão' : type === 'attribute' ? 'Atributo' : type === 'action' ? 'Nova Ação' : 'Novo KPI',
                    description: '',
                    x: startX,
                    y: startY,
                    color: parentNode ? parentNode.color : 'blue'
                };

                const newNodes = [...nodes, newNode];
                let newEdges = edges;

                if (parentId) {
                    newEdges = [...edges, { id: `e${parentId}-${newNodeId}`, source: parentId, target: newNodeId }];
                }
                
                setNodes(newNodes);
                setEdges(newEdges);
                saveToCloud(newNodes, newEdges);
                setSelectedNodeId(newNodeId);
            };

            const handleDeleteNode = () => {
                if (!selectedNodeId) return;
                const newNodes = nodes.filter(n => n.id !== selectedNodeId);
                const newEdges = edges.filter(e => e.source !== selectedNodeId && e.target !== selectedNodeId);
                
                setNodes(newNodes);
                setEdges(newEdges);
                saveToCloud(newNodes, newEdges);
                setSelectedNodeId(null);
            };

            // --- Renderização Visual ---
            const getPath = (start, end) => {
                let startOffset = 220;
                if (start.type === 'dimension') startOffset = 150;
                if (start.type === 'attribute') startOffset = 180;
                if (start.type === 'action') startOffset = 230;
                if (start.type === 'kpi') startOffset = 180;

                const sx = start.x + startOffset; 
                const sy = start.y + 40; 
                const ex = end.x;
                const ey = end.y + 40;
                const control = Math.abs(ex - sx) * 0.4;

                return `M ${sx} ${sy} C ${sx + control} ${sy}, ${ex - control} ${ey}, ${ex} ${ey}`;
            };

            const selectedNode = nodes.find(n => n.id === selectedNodeId);
            
            const availableParents = nodes.filter(n => 
                n.id !== selectedNodeId && 
                n.type !== 'kpi' 
            );

            const renderNode = (node) => {
                const theme = THEMES[node.color] || THEMES.blue;
                const isSelected = selectedNodeId === node.id;
                const commonClasses = `absolute cursor-grab active:cursor-grabbing shadow-sm transition-all hover:shadow-md select-none group flex flex-col justify-center
                    ${isSelected ? 'ring-2 ring-offset-2 ring-slate-400 z-30' : 'z-10'}
                `;

                if (node.type === 'dimension') {
                    return (
                        <div
                            key={node.id}
                            data-nodeid={node.id}
                            className={`${commonClasses} w-[180px] h-[180px] rounded-full text-white items-center text-center p-4`}
                            style={{ left: node.x, top: node.y, backgroundColor: theme.main }}
                        >
                            <Icons.Target className="w-8 h-8 mb-2 opacity-90" />
                            <span className="font-bold text-xl leading-tight tracking-wider uppercase">{node.label}</span>
                        </div>
                    );
                }
                if (node.type === 'attribute') {
                    return (
                        <div
                            key={node.id}
                            data-nodeid={node.id}
                            className={`${commonClasses} w-[200px] min-h-[80px] bg-white rounded-2xl border-l-[8px] pl-4 pr-3 py-3`}
                            style={{ left: node.x, top: node.y, borderColor: theme.main }}
                        >
                            <div className="flex items-center gap-2 mb-1 opacity-60">
                                <Icons.Layers className="w-3 h-3" style={{ color: theme.main }} />
                                <span className="text-[10px] font-bold uppercase tracking-wider text-slate-500">Atributo</span>
                            </div>
                            <span className="font-bold text-lg text-slate-800 leading-snug">{node.label}</span>
                        </div>
                    );
                }
                if (node.type === 'action') {
                    return (
                        <div
                            key={node.id}
                            data-nodeid={node.id}
                            className={`${commonClasses} w-[240px] min-h-[90px] bg-white rounded-lg border border-slate-200 overflow-hidden`}
                            style={{ left: node.x, top: node.y }}
                        >
                            <div className="bg-slate-50 px-3 py-2 border-b border-slate-100 flex items-center gap-2">
                                <Icons.Play className="w-3 h-3" style={{ fill: theme.main, color: theme.main }} />
                                <span className="text-[10px] font-bold uppercase tracking-wider text-slate-500 truncate">{node.label}</span>
                            </div>
                            <div className="p-3">
                                <span className="font-medium text-xs text-slate-700 leading-relaxed block whitespace-pre-wrap">
                                    {node.description || "..."}
                                </span>
                            </div>
                        </div>
                    );
                }
                if (node.type === 'kpi') {
                    return (
                        <div
                            key={node.id}
                            data-nodeid={node.id}
                            className={`${commonClasses} w-[200px] min-h-[60px] bg-white rounded-lg border-2 border-dashed pl-3 pr-2 py-2`}
                            style={{ left: node.x, top: node.y, borderColor: theme.main, backgroundColor: theme.light }}
                        >
                            <div className="flex items-center gap-2 mb-1">
                                <Icons.BarChart3 className="w-3 h-3" style={{ color: theme.main }} />
                                <span className="text-[10px] font-bold uppercase tracking-wider" style={{ color: theme.main }}>KPI</span>
                            </div>
                            <span className="font-bold text-xs text-slate-800 leading-snug">{node.label}</span>
                        </div>
                    );
                }
            };

            if (isSyncing && nodes.length === 0) {
                return (
                    <div className="flex h-screen w-full items-center justify-center bg-slate-50 flex-col gap-4">
                        <div className="loader"></div>
                        <p className="text-slate-500 text-sm font-medium">Sincronizando com a Nuvem...</p>
                    </div>
                );
            }

            return (
                <div className="flex h-screen w-full bg-slate-50 overflow-hidden text-slate-800 font-sans">
                    
                    {/* --- Sidebar Fixa --- */}
                    <div className="w-80 bg-white border-r border-slate-200 shadow-xl z-50 flex flex-col shrink-0">
                        <div className="p-4 border-b border-slate-100 flex justify-between items-center">
                            <div>
                                <h1 className="font-bold text-lg text-slate-800 flex items-center gap-2">
                                    <Icons.Layout className="w-5 h-5 text-blue-600" />
                                    Estratégia Ypê
                                </h1>
                                <p className="text-[10px] text-emerald-600 font-semibold flex items-center gap-1 mt-1">
                                    <Icons.CloudCheck className="w-3 h-3" /> Online & Sincronizado
                                </p>
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto p-4 custom-scrollbar bg-slate-50/50">
                            {selectedNode ? (
                                <div className="space-y-4 animate-fadeIn">
                                    
                                    {/* Edição de Conteúdo */}
                                    <div className="bg-white p-3 rounded-lg border border-slate-200 shadow-sm">
                                        <label className="block text-[10px] font-bold uppercase text-slate-400 mb-1">Título</label>
                                        <div className="flex items-center gap-2 pb-1">
                                            <Icons.Type className="w-4 h-4 text-slate-400" />
                                            <input 
                                                type="text"
                                                value={selectedNode.label} 
                                                onChange={(e) => handleUpdateNode(selectedNode.id, 'label', e.target.value)}
                                                className="w-full bg-transparent outline-none text-sm font-semibold text-slate-700 leading-snug"
                                            />
                                        </div>
                                        
                                        {selectedNode.type === 'action' && (
                                            <div className="mt-3 pt-3 border-t border-slate-100">
                                                <label className="block text-[10px] font-bold uppercase text-slate-400 mb-1">Detalhamento (Métodos)</label>
                                                <div className="flex gap-2">
                                                    <Icons.AlignLeft className="w-4 h-4 text-slate-400 mt-1" />
                                                    <textarea 
                                                        value={selectedNode.description} 
                                                        onChange={(e) => handleUpdateNode(selectedNode.id, 'description', e.target.value)}
                                                        className="w-full bg-transparent outline-none text-xs text-slate-600 resize-none h-24 leading-relaxed"
                                                    />
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    {/* Seção de Vínculo/Hierarquia */}
                                    {selectedNode.type !== 'dimension' && (
                                        <div className="bg-blue-50 p-3 rounded-lg border border-blue-100">
                                            <label className="block text-[10px] font-bold uppercase text-blue-400 mb-2 flex items-center gap-1">
                                                <Icons.Link className="w-3 h-3" /> Hierarquia / Vínculo
                                            </label>
                                            <div className="relative">
                                                <select 
                                                    className="w-full text-xs p-2 border border-blue-200 rounded bg-white text-slate-700 focus:outline-none focus:ring-2 focus:ring-blue-300"
                                                    value={getParentId(selectedNode.id)}
                                                    onChange={(e) => handleRelinkNode(selectedNode.id, e.target.value)}
                                                >
                                                    <option value="">-- Sem vínculo --</option>
                                                    {availableParents.map(p => (
                                                        <option key={p.id} value={p.id}>
                                                            {p.label.substring(0, 30)}{p.label.length > 30 ? '...' : ''} ({p.type})
                                                        </option>
                                                    ))}
                                                </select>
                                            </div>
                                            <p className="text-[10px] text-blue-400 mt-2 leading-tight">
                                                Selecione um novo "pai" para mover este item e herdar sua cor.
                                            </p>
                                        </div>
                                    )}

                                    {/* Seção de Cores */}
                                    <div>
                                        <label className="block text-[10px] font-bold uppercase text-slate-400 mb-2">Cor do Tema</label>
                                        <div className="grid grid-cols-5 gap-2">
                                            {Object.keys(THEMES).map(colorKey => (
                                                <button
                                                    key={colorKey}
                                                    onClick={() => handleUpdateNode(selectedNode.id, 'color', colorKey)}
                                                    className={`w-6 h-6 rounded-full border transition-transform hover:scale-110 flex items-center justify-center ${selectedNode.color === colorKey ? 'ring-2 ring-offset-2 ring-slate-400' : ''}`}
                                                    style={{ backgroundColor: THEMES[colorKey].main, borderColor: THEMES[colorKey].border }}
                                                />
                                            ))}
                                        </div>
                                    </div>

                                    {/* Botões de Ação */}
                                    <div className="pt-4 border-t border-slate-200">
                                        <label className="block text-[10px] font-bold uppercase text-slate-400 mb-2">Adicionar Filhos</label>
                                        <div className="grid grid-cols-1 gap-2">
                                            <button onClick={() => handleAddNode('attribute')} className="btn-add">
                                                <Icons.Layers className="w-3 h-3 text-blue-500" /> + Atributo
                                            </button>
                                            <button onClick={() => handleAddNode('action')} className="btn-add">
                                                <Icons.Play className="w-3 h-3 text-emerald-500" /> + Ação/Processo
                                            </button>
                                            <button onClick={() => handleAddNode('kpi')} className="btn-add">
                                                <Icons.BarChart3 className="w-3 h-3 text-purple-500" /> + KPI / Resultado
                                            </button>
                                        </div>
                                        
                                        <button 
                                            onClick={handleDeleteNode}
                                            className="w-full mt-4 flex items-center justify-center gap-2 text-red-600 hover:bg-red-50 p-2 rounded-md transition-colors text-xs font-bold uppercase border border-transparent hover:border-red-100"
                                        >
                                            <Icons.Trash2 className="w-3 h-3" /> Excluir
                                        </button>
                                    </div>
                                </div>
                            ) : (
                                <div className="h-full flex flex-col items-center justify-center text-slate-400 text-center opacity-60">
                                    <Icons.MousePointer2 className="w-10 h-10 mb-2 text-slate-300" />
                                    <p className="text-xs">Selecione um item para editar, vincular ou colorir.</p>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* --- Canvas --- */}
                    <div 
                        ref={containerRef}
                        className="flex-1 relative overflow-hidden bg-slate-50/50 cursor-grab active:cursor-grabbing"
                        onMouseDown={handleMouseDown}
                        onMouseMove={handleMouseMove}
                        onMouseUp={handleMouseUp}
                        onMouseLeave={handleMouseUp}
                    >
                        {/* Grid e Linhas */}
                        <div 
                            className="absolute inset-0 pointer-events-none opacity-[0.05]"
                            style={{
                                backgroundImage: `linear-gradient(#000 1px, transparent 1px), linear-gradient(90deg, #000 1px, transparent 1px)`,
                                backgroundSize: `${20 * scale}px ${20 * scale}px`,
                                backgroundPosition: `${pan.x}px ${pan.y}px`
                            }}
                        />

                        <div 
                            className="absolute origin-top-left transition-transform duration-75 ease-linear"
                            style={{ transform: `translate(${pan.x}px, ${pan.y}px) scale(${scale})` }}
                        >
                            <svg className="absolute top-0 left-0 w-[8000px] h-[8000px] pointer-events-none overflow-visible">
                                {edges.map(edge => {
                                    const source = nodes.find(n => n.id === edge.source);
                                    const target = nodes.find(n => n.id === edge.target);
                                    if (!source || !target) return null;
                                    const theme = THEMES[source.color] || THEMES.blue;
                                    return (
                                        <path
                                            key={edge.id}
                                            d={getPath(source, target)}
                                            stroke={theme.border}
                                            strokeWidth={source.type === 'dimension' ? 4 : 2} 
                                            fill="none"
                                        />
                                    );
                                })}
                            </svg>

                            {nodes.map(renderNode)}
                        </div>

                        {/* Botão Nova Dimensão */}
                        <button
                            onClick={() => { setSelectedNodeId(null); handleAddNode('dimension'); }}
                            className="absolute top-6 left-1/2 -translate-x-1/2 bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-full shadow-lg font-bold flex items-center gap-2 transition-transform hover:scale-105 active:scale-95 z-50"
                        >
                            <Icons.Plus className="w-5 h-5" /> Nova Dimensão
                        </button>

                        {/* Controles Zoom */}
                        <div className="absolute bottom-6 right-6 flex gap-2">
                            <div className="bg-white p-1 rounded-lg shadow-lg border border-slate-200 flex flex-col gap-1">
                                <button onClick={() => setScale(s => Math.min(s + 0.1, 2))} className="p-2 hover:bg-slate-50 rounded text-slate-600"><Icons.ZoomIn className="w-5 h-5" /></button>
                                <button onClick={() => setScale(s => Math.max(s - 0.1, 0.2))} className="p-2 hover:bg-slate-50 rounded text-slate-600"><Icons.ZoomOut className="w-5 h-5" /></button>
                                <button onClick={() => { setScale(0.5); setPan({x:50, y:50}); }} className="p-2 hover:bg-slate-50 rounded text-slate-600"><Icons.Maximize className="w-5 h-5" /></button>
                            </div>
                        </div>

                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
    <style>
        .btn-add {
            @apply flex items-center gap-2 px-3 py-2 bg-slate-50 border border-slate-200 rounded-md hover:bg-white hover:shadow-sm text-xs font-medium text-slate-600 transition-all text-left;
        }
    </style>
</body>
</html>

